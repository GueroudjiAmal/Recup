# Mini App:
This wokflow corresponds to an image processing pipeline: normalization, grayscale, filtering and segmentation.
MiniApp with: ​
- 3 launching modes (MPI, localCluster, Distributed)​
     * By default the code will run a LocalCluster, but you can configure it to be launched using `dask-mpi` or in a distributed configuration
     * Here is an example `python image_processing.py --mode=distributed --scheduler-file=scheduler.json` 
- 2 Yappi modes (CPU/WALL) time​
     * By default yappi will output WALL time but you can choose to output CPU time
     * Here is an example `python image_processing.py --tappi=cpu`


# Dataset:
This pipeline has been tested with [Breast Cancer Semantic Segmentation (BCSS) dataset](https://github.com/PathologyDataScience/BCSS)
It contains 150 images 
# Metadata Collection:
  * Job level:
      *  Cluster configuration: number of workers, threads per worker, memory
      *  Dask distributed internal configuration: admin, client, worker, communications, dashboard, deploy ...

  * Dask Workflow system level:
      *  [Dask performance report](): html file generated by dask 
      *  Task stream: a yaml file of the tasks. For each task there is a key, metadata, nbytes, action, start, stop, status, thread, typename, worker  ​
  
  * System level:
      * [Darshan](https://www.mcs.anl.gov/research/projects/darshan/) reports for capturing the IOs
      * [Yappi](https://pypi.org/project/yappi/) outputs of wall/cpu time and call count of all called coroutine

# Requirements
  * [Dataset requirements](https://github.com/PathologyDataScience/BCSS/blob/master/README.md) Dask, Distributed, Dask-image, skimage, Darshan , yappi

# Running the MiniApp:

To run the Mini App make sure to specify the path to the `libdarshan.so` et get Darshan reports  
`DARSHAN_ENABLE_NONMPI=1 DARSHAN_CONFIG_PATH="config.txt" LD_PRELOAD="/path/to/lib/libdarshan.so" python image_processing.py`

Reports will be in a directory called `RUN` prefixed with the data and time for example `20240117-130349-RUN`.
There will be two subdirs:
  + Reports: which contains generated logs, performance reports and configurations:
    *  `dask_performance_report.html` 
    *  `distributed.yaml` contains dask distributed internal configuration
    *  `task_stream.yaml` contains all the task stream collected from the scheduler
    *  `yappi.debug.yaml` `yappi.pstat` contains the debug reports from yappi
    *  `hostname_python_id*.darshan` contains darshan outputs
  + Results:
    * `Labeled`: a Dir of labeled images
    * `Normalized`: a dir of the normalized images
    * `Threshold`: a dir of the images afer a 0.75*max threshold was applied
